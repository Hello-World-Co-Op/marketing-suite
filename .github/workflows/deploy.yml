name: Deploy Marketing Suite

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@hello-world-co-op'
          cache: 'npm'

      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_READ_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          if [ -f package-lock.json ] && ! grep -q '"link": true' package-lock.json && ! grep -q '"file:' package-lock.json; then
            npm ci
          else
            echo "::warning::Lock file contains link/file references, using npm install"
            rm -f package-lock.json
            npm install
          fi

      - name: Run tests
        run: npm test

      - name: Build test
        run: npm run build

  deploy-staging:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@hello-world-co-op'
          cache: 'npm'

      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_READ_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          if [ -f package-lock.json ] && ! grep -q '"link": true' package-lock.json && ! grep -q '"file:' package-lock.json; then
            npm ci
          else
            echo "::warning::Lock file contains link/file references, using npm install"
            rm -f package-lock.json
            npm install
          fi

      - name: Create .well-known directory
        run: |
          mkdir -p public/.well-known
          echo "www.helloworlddao.com" > public/.well-known/ic-domains

      - name: Build for staging
        env:
          VITE_IC_HOST: "https://ic0.app"
          VITE_AUTH_CANISTER_ID: ${{ vars.VITE_AUTH_CANISTER_ID || 'gexqh-jqaaa-aaaae-acsxq-cai' }}
          VITE_USER_SERVICE_CANISTER_ID: ${{ vars.VITE_USER_SERVICE_CANISTER_ID || 'j4rvr-3aaaa-aaaao-qkvfq-cai' }}
          VITE_BLOG_CANISTER_ID: ${{ vars.VITE_BLOG_CANISTER_ID || 'dsqvo-niaaa-aaaao-a6ynq-cai' }}
          VITE_ORACLE_BRIDGE_URL: ${{ vars.VITE_ORACLE_BRIDGE_URL || 'https://staging-oracle.helloworlddao.com' }}
          VITE_NETWORK: "ic"
          VITE_ENVIRONMENT: "staging"
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -f dist/index.html ]; then
            echo "ERROR: Build did not produce dist/index.html"
            exit 1
          fi
          echo "Build output verified"

      - name: Install dfx
        uses: dfinity/setup-dfx@main
        with:
          dfx-version: "0.24.3"

      - name: Import dfx identity
        run: |
          mkdir -p ~/.config/dfx/identity/github-ci
          echo "${{ secrets.DFX_IDENTITY_PEM }}" > ~/.config/dfx/identity/github-ci/identity.pem
          chmod 600 ~/.config/dfx/identity/github-ci/identity.pem
          dfx identity use github-ci

      - name: Deploy to IC
        env:
          DFX_WARNING: "-mainnet_plaintext_identity"
        run: |
          # Hide vite config so dfx doesn't auto-detect and rebuild
          mv vite.config.ts vite.config.ts.bak 2>/dev/null || true
          mv package.json package.json.bak

          # Create minimal package.json with no-op build script
          echo '{"name":"marketing-suite","private":true,"scripts":{"build":"echo No build needed"}}' > package.json

          echo "=== Deploying pre-built dist ==="
          dfx deploy marketing_suite_assets --network ic --yes || {
            echo "Normal upgrade failed, attempting reinstall..."
            dfx deploy marketing_suite_assets --network ic --yes --mode reinstall
          }

          # Restore original files
          mv vite.config.ts.bak vite.config.ts 2>/dev/null || true
          mv package.json.bak package.json

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | marketing-suite |" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | https://www.helloworlddao.com |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup identity
        if: always()
        run: |
          rm -rf ~/.config/dfx/identity/github-ci
          echo "Identity PEM cleaned up"
